
import logging
import sys
import os
from datetime import datetime
from logging.handlers import RotatingFileHandler, TimedRotatingFileHandler
from typing import Optional

def setup_logging(name: str = None, level: int = logging.INFO, 
                  log_file: str = None, max_bytes: int = 10*1024*1024,
                  backup_count: int = 5) -> logging.Logger:
    """
    Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ
    
    Args:
        name: Ù†Ø§Ù… logger
        level: Ø³Ø·Ø­ Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ
        log_file: Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„ Ù„Ø§Ú¯
        max_bytes: Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ø§ÛŒØ² ÙØ§ÛŒÙ„ Ù„Ø§Ú¯
        backup_count: ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ú©â€ŒØ¢Ù¾
        
    Returns:
        logging.Logger: Ø´ÛŒØ¡ logger
    """
    if name is None:
        name = __name__
    
    logger = logging.getLogger(name)
    
    # Ø§Ú¯Ø± logger Ø§Ø² Ù‚Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ØŒ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù‡Ù…Ø§Ù†
    if logger.handlers:
        return logger
    
    logger.setLevel(level)
    
    # ÙØ±Ù…Øª Ù„Ø§Ú¯
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    
    # Handler Ú©Ù†Ø³ÙˆÙ„
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(level)
    console_handler.setFormatter(formatter)
    logger.addHandler(console_handler)
    
    # Handler ÙØ§ÛŒÙ„
    if log_file:
        # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ
        os.makedirs(os.path.dirname(log_file), exist_ok=True)
        
        file_handler = RotatingFileHandler(
            log_file, 
            maxBytes=max_bytes, 
            backupCount=backup_count,
            encoding='utf-8'
        )
        file_handler.setLevel(level)
        file_handler.setFormatter(formatter)
        logger.addHandler(file_handler)
    
    # Handler Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§
    error_handler = logging.StreamHandler(sys.stderr)
    error_handler.setLevel(logging.ERROR)
    error_handler.setFormatter(formatter)
    logger.addHandler(error_handler)
    
    return logger

def get_logger(name: str = None) -> logging.Logger:
    """
    Ø¯Ø±ÛŒØ§ÙØª logger Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
    
    Args:
        name: Ù†Ø§Ù… logger
        
    Returns:
        logging.Logger: Ø´ÛŒØ¡ logger
    """
    return setup_logging(name)

class PerformanceLogger:
    """Ù„Ø§Ú¯Ø± Ù…Ø®ØµÙˆØµ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ùˆ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ"""
    
    def __init__(self, name: str = "performance"):
        self.logger = setup_logging(name)
        self.timers = {}
    
    def start_timer(self, operation: str):
        """Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ø¹Ù…Ù„ÛŒØ§Øª"""
        self.timers[operation] = datetime.now()
        self.logger.info(f"â±ï¸ Starting operation: {operation}")
    
    def stop_timer(self, operation: str) -> float:
        """ØªÙˆÙ‚Ù ØªØ§ÛŒÙ…Ø± Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§"""
        if operation not in self.timers:
            self.logger.warning(f"Timer for operation '{operation}' not found")
            return 0.0
        
        start_time = self.timers[operation]
        execution_time = (datetime.now() - start_time).total_seconds()
        
        self.logger.info(f"âœ… Operation '{operation}' completed in {execution_time:.3f} seconds")
        del self.timers[operation]
        
        return execution_time
    
    def log_performance_metric(self, metric: str, value: float, unit: str = ""):
        """Ø«Ø¨Øª Ù…Ø¹ÛŒØ§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯"""
        self.logger.info(f"ğŸ“Š Performance Metric - {metric}: {value} {unit}".strip())

class SecurityLogger:
    """Ù„Ø§Ú¯Ø± Ù…Ø®ØµÙˆØµ Ø§Ù…Ù†ÛŒØª Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    def __init__(self, name: str = "security"):
        self.logger = setup_logging(name)
    
    def log_login_attempt(self, user_id: str, ip: str, success: bool):
        """Ø«Ø¨Øª ØªÙ„Ø§Ø´ ÙˆØ±ÙˆØ¯"""
        status = "SUCCESS" if success else "FAILED"
        self.logger.info(f"ğŸ” Login attempt - User: {user_id}, IP: {ip}, Status: {status}")
    
    def log_api_call(self, endpoint: str, method: str, user_id: str = "unknown"):
        """Ø«Ø¨Øª ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API"""
        self.logger.info(f"ğŸŒ API Call - {method} {endpoint} by User: {user_id}")
    
    def log_suspicious_activity(self, activity: str, details: str):
        """Ø«Ø¨Øª ÙØ¹Ø§Ù„ÛŒØª Ù…Ø´Ú©ÙˆÚ©"""
        self.logger.warning(f"ğŸš¨ Suspicious Activity - {activity}: {details}")

class TradingLogger:
    """Ù„Ø§Ú¯Ø± Ù…Ø®ØµÙˆØµ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ùˆ Ø³ÛŒÚ¯Ù†Ø§Ù„â€ŒÙ‡Ø§"""
    
    def __init__(self, name: str = "trading"):
        self.logger = setup_logging(name)
    
    def log_signal_generated(self, symbol: str, signal_type: str, confidence: float):
        """Ø«Ø¨Øª ØªÙˆÙ„ÛŒØ¯ Ø³ÛŒÚ¯Ù†Ø§Ù„"""
        self.logger.info(f"ğŸ“ˆ Signal Generated - {symbol}: {signal_type} (Confidence: {confidence:.2f})")
    
    def log_trade_execution(self, symbol: str, action: str, quantity: float, price: float):
        """Ø«Ø¨Øª Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡"""
        self.logger.info(f"ğŸ’° Trade Executed - {symbol}: {action} {quantity} @ {price}")
    
    def log_portfolio_update(self, total_value: float, profit_loss: float):
        """Ø«Ø¨Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ØªÙÙˆÙ„ÛŒÙˆ"""
        self.logger.info(f"ğŸ“Š Portfolio Update - Total: {total_value:.2f}, P&L: {profit_loss:.2f}")

# Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÛŒÙ†Ú¯Ù„ØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¢Ø³Ø§Ù†
performance_logger = PerformanceLogger()
security_logger = SecurityLogger()
trading_logger = TradingLogger()
